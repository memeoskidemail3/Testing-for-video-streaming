'use strict';var _createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,'value'in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var VideoPlayer=function(){function a(b,c){var d=this;if(_classCallCheck(this,a),this._callback='function'==typeof c?c:function(k,l){return k?void console.error('VideoPlayer Error: '+k+' '+d._namespace):void console.log('VideoPlayer Message: '+l+' '+d._namespace)},!b.video||!(b.video instanceof HTMLVideoElement))return void this._callback('"options.video" is not a video element');if(!b.namespace)return void this._callback('missing "options.namespace"');if(!b.io||!b.io.hasOwnProperty('Socket'))return void this._callback('"options.io is not an instance of socket.io');if(this._video=b.video,b.controls){var e=-1!==b.controls.indexOf('startstop'),f=-1!==b.controls.indexOf('fullscreen');if(e||f){var g=document.createElement('div');if(g.className='video',this._video.parentNode.replaceChild(g,this._video),this._video.className='mse',this._video.controls=!1,this._video.removeAttribute('controls'),g.appendChild(this._video),e){var h=document.createElement('button');h.innerHTML='<i class="fa fa-play fa-2x" style="color:white" aria-hidden="true"></i>',h.className='startstop',h.addEventListener('click',function(){alert('start/stop button not implemented yet')}),g.appendChild(h)}if(f){var j=document.createElement('button');j.innerHTML='<i class="fa fa-arrows-alt fa-2x" style="color:white" aria-hidden="true"></i>',j.className='fullscreen',j.addEventListener('click',function(){d._video.parentNode.requestFullscreen?d._video.parentNode.requestFullscreen():d._video.parentNode.mozRequestFullScreen?d._video.parentNode.mozRequestFullScreen():d._video.parentNode.webkitRequestFullScreen?d._video.parentNode.webkitRequestFullScreen():d._video.parentNode.msRequestFullscreen&&d._video.parentNode.msRequestFullscreen()}),g.appendChild(j)}}}return this._addVideoEvents(),this._namespace=b.namespace,this._io=b.io,this}return _createClass(a,[{key:'_createControls',value:function _createControls(){}},{key:'start',value:function start(){return this._socket=this._io(location.origin+'/'+this._namespace,{transports:['websocket'],forceNew:!1}),this._addSocketEvents(),this}},{key:'stop',value:function stop(){}},{key:'destroy',value:function destroy(){}},{key:'mediaInfo',value:function mediaInfo(){var b='******************\n';b+='namespace : '+this._namespace+'\n',this._video&&(b+='video.paused : '+this._video.paused+'\nvideo.currentTime : '+this._video.currentTime+'\nvideo.src : '+this._video.src+'\n',this._sourceBuffer.buffered.length&&(b+='buffered.length : '+this._sourceBuffer.buffered.length+'\nbuffered.end(0) : '+this._sourceBuffer.buffered.end(0)+'\nbuffered.start(0) : '+this._sourceBuffer.buffered.start(0)+'\nbuffered size : '+(this._sourceBuffer.buffered.end(0)-this._sourceBuffer.buffered.start(0))+'\nlag : '+(this._sourceBuffer.buffered.end(0)-this._video.currentTime)+'\n')),b+='******************\n',console.info(b)}},{key:'_cleanUp',value:function _cleanUp(){this._callback(null,'CLEAN UP'),this._video&&(this._removeVideoEvents(),this._video.pause(),this._video.src='',this._video.load()),this._socket&&(this._removeSocketEvents(),this._socket.disconnect(),delete this._socket),this._mediaSource&&(this._removeMediaSourceEvents(),this._mediaSource.sourceBuffers.length&&this._mediaSource.removeSourceBuffer(this._sourceBuffer),URL.revokeObjectURL(this._mediaSource),delete this._mediaSource),this._sourceBuffer&&(this._removeSourceBufferEvents(),this._sourceBuffer.updating&&this._sourceBuffer.abort(),delete this._sourceBuffer)}},{key:'_onVideoError',value:function _onVideoError(b){this._callback('video '+b.type)}},{key:'_addVideoEvents',value:function _addVideoEvents(){this._video&&(this.onVideoError=this._onVideoError.bind(this),this._video.addEventListener('error',this.onVideoError,{capture:!0,passive:!0,once:!0}))}},{key:'_removeVideoEvents',value:function _removeVideoEvents(){this._video&&(this._video.removeEventListener('error',this.onVideoError,{capture:!0,passive:!0,once:!0}),delete this.onVideoError)}},{key:'_onMediaSourceClose',value:function _onMediaSourceClose(b){this._callback(null,'media source close '+b.type)}},{key:'_onMediaSourceOpen',value:function _onMediaSourceOpen(){var c=this;URL.revokeObjectURL(this._video.src),this._mediaSource.duration=Number.POSITIVE_INFINITY,this._sourceBuffer=this._mediaSource.addSourceBuffer(this._mime),this._sourceBuffer.mode='sequence',this._addSourceBufferEvents(),this._sourceBuffer.appendBuffer(this._init),this.onSegment=this._onSegment.bind(this),this._socket.addEventListener('segment',this.onSegment,{capture:!0,passive:!0,once:!1}),this._socket.send('segments'),'Promise'in window?this._video.play().then(function(){}).catch(function(d){c._callback(d)}):this._video.play()}},{key:'_addMediaSourceEvents',value:function _addMediaSourceEvents(){this._mediaSource&&(this.onMediaSourceClose=this._onMediaSourceClose.bind(this),this._mediaSource.addEventListener('sourceclose',this.onMediaSourceClose,{capture:!0,passive:!0,once:!0}),this.onMediaSourceOpen=this._onMediaSourceOpen.bind(this),this._mediaSource.addEventListener('sourceopen',this.onMediaSourceOpen,{capture:!0,passive:!0,once:!0}))}},{key:'_removeMediaSourceEvents',value:function _removeMediaSourceEvents(){this._mediaSource&&(this._mediaSource.removeEventListener('sourceclose',this.onMediaSourceClose,{capture:!0,passive:!0,once:!0}),delete this.onMediaSourceClose,this._mediaSource.removeEventListener('sourceopen',this.onMediaSourceOpen,{capture:!0,passive:!0,once:!0}),delete this.onMediaSourceOpen)}},{key:'_onSourceBufferError',value:function _onSourceBufferError(b){this._callback('sourceBufferError '+b.type)}},{key:'_onSourceBufferUpdateEnd',value:function _onSourceBufferUpdateEnd(){if(!this._sourceBuffer.updating){if(this._lastSegment)return this._sourceBuffer.appendBuffer(this._lastSegment),void delete this._lastSegment;if(this._sourceBuffer.buffered.length){var c=this._video.currentTime,d=this._sourceBuffer.buffered.start(0),e=this._sourceBuffer.buffered.end(0);20<c-d&&c<e&&this._sourceBuffer.remove(d,c-4)}}}},{key:'_addSourceBufferEvents',value:function _addSourceBufferEvents(){this._sourceBuffer&&(this.onSourceBufferError=this._onSourceBufferError.bind(this),this._sourceBuffer.addEventListener('error',this.onSourceBufferError,{capture:!0,passive:!0,once:!0}),this.onSourceBufferUpdateEnd=this._onSourceBufferUpdateEnd.bind(this),this._sourceBuffer.addEventListener('updateend',this.onSourceBufferUpdateEnd,{capture:!0,passive:!0,once:!1}))}},{key:'_removeSourceBufferEvents',value:function _removeSourceBufferEvents(){this._sourceBuffer&&(this._sourceBuffer.removeEventListener('error',this.onSourceBufferError,{capture:!0,passive:!0,once:!0}),delete this.onSourceBufferError,this._sourceBuffer.removeEventListener('updateend',this.onSourceBufferUpdateEnd,{capture:!0,passive:!0,once:!1}),delete this.onSourceBufferUpdateEnd)}},{key:'_onSocketConnect',value:function _onSocketConnect(){this.onMime=this._onMime.bind(this),this._socket.addEventListener('mime',this.onMime,{capture:!0,passive:!0,once:!0}),this._socket.send('mime')}},{key:'_onSocketDisconnect',value:function _onSocketDisconnect(b){this._callback('socket disconnect "'+b+'"'),this._cleanUp()}},{key:'_onSocketError',value:function _onSocketError(b){this._callback('socket error "'+b+'"'),this._cleanUp()}},{key:'_onMime',value:function _onMime(b){return this._mime=b,MediaSource.isTypeSupported(this._mime)?void(this.onInit=this._onInit.bind(this),this._socket.addEventListener('initialization',this.onInit,{capture:!0,passive:!0,once:!0}),this._socket.send('initialization')):(this._video.setAttribute('poster','data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjM0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnPjxyZWN0IHg9Ii0xIiB5PSItMSIgd2lkdGg9IjY0MiIgaGVpZ2h0PSIzNiIgZmlsbD0ibm9uZSIvPjwvZz48Zz48dGV4dCBmaWxsPSIjMDAwIiBzdHJva2Utd2lkdGg9IjAiIHg9IjE3NyIgeT0iMjYiIGZvbnQtc2l6ZT0iMjYiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHhtbDpzcGFjZT0icHJlc2VydmUiIHN0cm9rZT0iIzAwMCI+bWltZSB0eXBlIG5vdCBzdXBwb3J0ZWQ8L3RleHQ+PC9nPjwvc3ZnPg=='),void this._callback('unsupported mime "'+this._mime+'"'))}},{key:'_onInit',value:function _onInit(b){this._init=b,this._mediaSource=new MediaSource,this._addMediaSourceEvents(),this._video.src=URL.createObjectURL(this._mediaSource)}},{key:'_onSegment',value:function _onSegment(b){if(this._sourceBuffer.buffered.length){var c=this._sourceBuffer.buffered.end(0)-this._video.currentTime;0.5<c&&(this._video.currentTime=this._sourceBuffer.buffered.end(0)-0.5)}this._sourceBuffer.updating?this._lastSegment=b:(delete this._lastSegment,this._sourceBuffer.appendBuffer(b))}},{key:'_addSocketEvents',value:function _addSocketEvents(){this._socket&&(this.onSocketConnect=this._onSocketConnect.bind(this),this._socket.addEventListener('connect',this.onSocketConnect,{capture:!0,passive:!0,once:!0}),this.onSocketDisconnect=this._onSocketDisconnect.bind(this),this._socket.addEventListener('disconnect',this.onSocketDisconnect,{capture:!0,passive:!0,once:!0}),this.onSocketError=this._onSocketError.bind(this),this._socket.addEventListener('error',this.onSocketError,{capture:!0,passive:!0,once:!0}))}},{key:'_removeSocketEvents',value:function _removeSocketEvents(){this._socket&&(this._socket.removeEventListener('connect',this.onSocketConnect,{capture:!0,passive:!0,once:!0}),delete this.onSocketConnect,this._socket.removeEventListener('disconnect',this.onSocketDisconnect,{capture:!0,passive:!0,once:!0}),delete this.onSocketDisconnect,this._socket.removeEventListener('error',this.onSocketError,{capture:!0,passive:!0,once:!0}),delete this.onSocketError,this._socket.removeEventListener('mime',this.onMime,{capture:!0,passive:!0,once:!0}),delete this.onMime,this._socket.removeEventListener('initialization',this.onInit,{capture:!0,passive:!0,once:!0}),delete this.onInit,this._socket.removeEventListener('segment',this.onSegment,{capture:!0,passive:!0,once:!1}),delete this.onSegment)}}]),a}();(function(){if(!('io'in window))throw new Error('socket.io was not found');for(var d,a=document.getElementsByTagName('video'),b=[],c=0;c<a.length;c++)d=a[c],d.dataset.namespace&&b.push(new VideoPlayer({video:d,io:io,namespace:d.dataset.namespace,controls:d.dataset.controls}).start())})();